<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Comparer Bases</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        button:active { animation: bounce 0.3s; }
        @keyframes bounce {
            0%   { transform: scale(1); }
            30%  { transform: scale(1.2); }
            50%  { transform: scale(0.9); }
            70%  { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .separator { border-left: 3px solid #0b3d91; }
    </style>
</head>

<body class="container py-4">

<h2 class="mb-4">Comparer des bases de donn√©es</h2>

<form method="POST" action="{{ url_for('comparaison') }}" class="mb-5">

    <!-- ================== BASE 1 ================== -->
    <div class="mb-3">
        <label for="base1" class="form-label fw-bold">Base 1 :</label>
        <select id="base1" name="base1" class="form-select">

            {% for b in bases %}
                <option value="{{ b }}" {% if b == request.form.get('base1') %}selected{% endif %}>
                    {{ b }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- ================== BASE 2 ================== -->
    <div class="mb-4">
        <label for="base2" class="form-label fw-bold">Base 2 :</label>
        <select id="base2" name="base2" class="form-select">
            {% for b in bases %}
                <option value="{{ b }}" {% if b == request.form.get('base2') %}selected{% endif %}>
                    {{ b }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- ================== TABLES ================== -->
    {% if all_tables %}
    <div class="mb-4">
        <strong>Choisissez les tables √† comparer :</strong><br>
        {% for table in all_tables %}
            <div class="form-check">
                <input class="form-check-input"
                        type="checkbox"
                        name="tables"
                        value="{{ table }}"
                        id="table_{{ loop.index }}"
                        {% if table in request.form.getlist('tables') %}checked{% endif %}>
                <label class="form-check-label" for="table_{{ loop.index }}">
                    {{ table }}
                </label>
            </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- ================== COLONNES ================== -->
    {% if columns_by_table %}
    <div class="mb-4">
        <h5>S√©lectionner les colonnes √† comparer :</h5>
        {% for table, columns in columns_by_table.items() %}
            <strong>{{ table }}</strong><br>
            {% for col in columns %}
                <input type="checkbox"
                        name="columns_{{ table }}"
                        value="{{ col }}"
                        id="col_{{ table }}_{{ loop.index }}"
                        {% if col in request.form.getlist('columns_' + table) %}checked{% endif %}>
                <label for="col_{{ table }}_{{ loop.index }}">{{ col }}</label><br>
            {% endfor %}
        {% endfor %}
    </div>
    {% endif %}

    <!-- ================== BOUTON ================== -->
    <div class="mb-4">
        <button type="submit" class="btn btn-primary w-100 fw-bold">Comparer</button>
    </div>

</form>

<!-- ================== NOTIFICATION ================== -->
{% if notification %}
<div class="alert alert-info">
    {{ notification }}
</div>
{% endif %}

<!-- ================== DIFFERENCES ================== -->
{% for table, rows in tables_differences.items() %}
    <h4 class="mt-4">Table : {{ table }}</h4>
    <table class="table table-bordered differences-table">
        <thead>
            <tr>
                {% for col in selected_columns_by_table[table] %}
                    <th>{{ col }} (Base 1)</th>
                    <th>{{ col }} (Base 2)</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
                <tr>
                    {% for col in selected_columns_by_table[table] %}
                        <td>{{ row[col + '_base1'] }}</td>
                        <td>{{ row[col + '_base2'] }}</td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
{% endfor %}

<!-- Boutons copy/notify -->
<div class="d-flex gap-2 mt-3">
    <button type="button" id="copyAll" class="btn btn-success">üìã Copy</button>
    <button type="button" id="notifyAll" class="btn btn-warning">üîî Notify</button>
</div>

<a href="{{ url_for('index') }}" class="btn btn-secondary mt-4">
    ‚¨Ö Return to the reception
</a>

<!--  SCRIPT  -->
<script>
document.addEventListener("DOMContentLoaded", () => {
    const copyAllBtn = document.getElementById("copyAll");
    const notifyAllBtn = document.getElementById("notifyAll");

    if (copyAllBtn) {
        copyAllBtn.addEventListener("click", () => {
            const tables = document.querySelectorAll(".differences-table");
            let text = "";
            tables.forEach(table => {
                for (let i = 0; i < table.rows.length; i++) {
                    let rowText = [];
                    for (let j = 0; j < table.rows[i].cells.length; j++) {
                        rowText.push(table.rows[i].cells[j].innerText);
                    }
                    text += rowText.join("\t") + "\n";
                }
                text += "\n";
            });
            navigator.clipboard.writeText(text).then(() => alert("‚úÖ Differences are copied !"));
        });
    }

    if (notifyAllBtn) {

        notifyAllBtn.addEventListener("click", () => {
            const tables = document.querySelectorAll(".differences-table");
            const differencesArray = [];
            tables.forEach(table => {
                const headers = Array.from(table.rows[0].cells).map(cell => cell.innerText);
                for (let i = 1; i < table.rows.length; i++) {
                    const rowData = {};
                    headers.forEach((h, j) => { rowData[h] = table.rows[i].cells[j].innerText || "N/A"; });
                    differencesArray.push(rowData);
                }
            });
            if (differencesArray.length === 0) { alert("‚ùå Aucune diff√©rence √† notifier !"); return; }
            fetch("/notifier", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    differences: differencesArray,
                    base1: document.getElementById("base1").value,
                    
                    base2: document.getElementById("base2").value
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success") alert("‚úÖ Notification envoy√©e !");
                else alert("‚ùå Erreur : " + data.message);
            })
            .catch(() => alert("‚ùå Impossible d‚Äôenvoyer la notification."));
        });
    }
});
</script>


</body>
</html>