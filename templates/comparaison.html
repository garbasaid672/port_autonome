<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Comparer Bases</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
    /* S√©paration plus √©paisse entre Base 1 et Base 2 */
    #differencesTable td.separator,
    #differencesTable th.separator {
        border-left: 3px solid #0b3d91; /* ‚ö° Note l'espace entre solid et la couleur */
    }
    </style>
</head>

<body class="p-4">

<h2>Comparer des bases de donn√©es</h2>

<form method="POST" action="{{ url_for('comparaison') }}" >
  <div class="mb-3">
    <select name="base1" class="form-select" required>
  <option value="" disabled selected>La premi√®re base</option>
  {% for b in bases %}
    <option value="{{ b }}">{{ b }}</option>
  {% endfor %}
</select>

<select name="base2" class="form-select" required>
  <option value="" disabled selected>La deuxi√®me base</option>
  {% for b in bases %}
    <option value="{{ b }}">{{ b }}</option>
  {% endfor %}
</select>

  </div>

  <button type="submit" class="btn btn-primary">Comparer</button>
</form>

{% if notification %}
<div class="alert alert-info mt-4">
  {{ notification }}
</div>
{% endif %}

<h3 class="mt-4">{{ notification }}</h3>

<table class="table table-bordered" id="differencesTable">
    <thead class="table-light text-center">
        <tr>
            <th rowspan="2">Table</th>
            <th colspan="4">Base 1</th>
            <th class="separator" colspan="4">Base 2</th>
        </tr>
        <tr>
            <th>Identifiant</th>
            <th>Nom</th>
            <th>Age</th>
            <th class="separator">Identifiant</th>
            <th>Nom</th>
            <th>Age</th>
        </tr>
    </thead>
    <tbody>
        {% if differences %}
            {% for diff in differences %}
            <tr>
                <td>{{ diff.table }}</td>
                <td>{{ diff.base1_identifiant }}</td>
                <td>{{ diff.base1_nom }}</td>
                <td>{{ diff.base1_age }}</td>
                <td class="separator">{{ diff.base2_identifiant }}</td>
                <td>{{ diff.base2_nom }}</td>
                <td>{{ diff.base2_age }}</td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="9" class="text-center">Aucune diff√©rence √† afficher</td>
            </tr>
        {% endif %}
    </tbody>
</table>

<!-- BOUTONS -->
<button type="button" onclick="copyDifferences()" class="btn btn-success mt-3">
    üìã Copier
</button>
<button type="button" onclick="notifyDifferences()" class="btn btn-warning mt-3">
    üîî Notifier
</button>

<a href="{{ url_for('index') }}" class="btn btn-link mt-4">
  ‚¨Ö Retour √† la page d‚Äôaccueil
</a>

<!-- JS -->
<script>
function copyDifferences() {
    const table = document.getElementById("differencesTable");
    let text = "";
    for (let i = 1; i < table.rows.length; i++) {
        const row = table.rows[i];
        const champ = row.cells[0].innerText;
        const v1 = row.cells[1].innerText;
        const v2 = row.cells[2].innerText;
        if (champ !== "Aucune diff√©rence √† afficher") {
            text += champ + "\t" + v1 + "\t" + v2 + "\n";
        }
    }
    navigator.clipboard.writeText(text).then(() => {
        alert("‚úÖ Diff√©rences copi√©es dans le presse-papiers !");
    });
}

function notifyDifferences() {
    const table = document.getElementById("differencesTable");
    if (!table) {
        alert("‚ùå Aucune diff√©rence √† notifier !");
        return;
    }

    const differencesArray = [];
    for (let i = 1; i < table.rows.length; i++) {
        const row = table.rows[i];
        const champ = row.cells[0].innerText || "N/A";
        const v1 = row.cells[1].innerText || "N/A";
        const v2 = row.cells[2].innerText || "N/A";

        if (champ !== "Aucune diff√©rence √† afficher") {
            differencesArray.push({ champ: champ, v1: v1, v2: v2 });
        }
    }

    if (differencesArray.length === 0) {
        alert("‚ùå Aucune diff√©rence √† notifier !");
        return;
    }

    // ‚ö° Envoyer au serveur Flask /notifier
    fetch("/notifier", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ differences: differencesArray })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            alert("‚úÖ Notification envoy√©e !");
        } else {
            alert("‚ùå Erreur : " + data.message);
        }
    })
    .catch(error => {
        console.error(error);
        alert("‚ùå Impossible d‚Äôenvoyer la notification.");
    });
}
</script>

</body>
</html>
