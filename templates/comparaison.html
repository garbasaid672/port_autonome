<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Comparer Bases</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>

<body class="p-4">

<h2>Comparer des bases de donn√©es</h2>

<form method="POST" action="{{ url_for('comparaison') }}" >
  <div class="mb-3">
    <select name="base1" class="form-select" required>
      <option value="" disabled selected>La premi√®re base</option>
      {% for b in bases %}
        <option value="{{ b.id }}">{{ b.nom_base }}</option>
      {% endfor %}
    </select>
  </div>

  <div class="mb-3">
    <select name="base2" class="form-select" required>
      <option value="" disabled selected>La deuxi√®me base</option>
      {% for b in bases %}
        <option value="{{ b.id }}">{{ b.nom_base }}</option>
      {% endfor %}
    </select>
  </div>

  <button type="submit" class="btn btn-primary">Comparer</button>
</form>

{% if notification %}
<div class="alert alert-info mt-4">
  {{ notification }}
</div>
{% endif %}

<h3 class="mt-4">Diff√©rences trouv√©es</h3>

<table id="differencesTable" class="table table-bordered">
    <thead class="table-light">
        <tr>
            <th>Champ</th>
            <th>Base 1</th>
            <th>Base 2</th>
        </tr>
    </thead>
    <tbody>
        {% if differences %}
            {% for diff in differences %}
            <tr>
                <td>{{ diff.champ }}</td>
                <td>{{ diff.base1 }}</td>
                <td>{{ diff.base2 }}</td>
            </tr>
            {% endfor %}
        {% else %}
            <tr>
                <td colspan="3">Aucune diff√©rence √† afficher</td>
            </tr>
        {% endif %}
    </tbody>
</table>



<!-- BOUTONS -->
<button type="button" onclick="copyDifferences()" class="btn btn-success mt-3">
    üìã Copier
</button>
<button type="button" onclick="notifyDifferences()" class="btn btn-warning mt-3">
    üîî Notifier
</button>

<a href="{{ url_for('index') }}" class="btn btn-link mt-4">
  ‚¨Ö Retour √† la page d‚Äôaccueil
</a>

<!-- JS -->
<script>
function copyDifferences() {
    const table = document.getElementById("differencesTable");
    let text = "";
    for (let i = 1; i < table.rows.length; i++) {
        const row = table.rows[i];
        const champ = row.cells[0].innerText;
        const v1 = row.cells[1].innerText;
        const v2 = row.cells[2].innerText;
        if (champ !== "Aucune diff√©rence √† afficher") {
            text += champ + "\t" + v1 + "\t" + v2 + "\n";
        }
    }
    navigator.clipboard.writeText(text).then(() => {
        alert("‚úÖ Diff√©rences copi√©es dans le presse-papiers !");
    });
}

function notifyDifferences() {
    const table = document.getElementById("differencesTable");
    if (!table) {
        alert("‚ùå Aucune diff√©rence √† notifier !");
        return;
    }

    const differencesArray = [];
    for (let i = 1; i < table.rows.length; i++) {
        const row = table.rows[i];
        const champ = row.cells[0].innerText || "N/A";
        const v1 = row.cells[1].innerText || "N/A";
        const v2 = row.cells[2].innerText || "N/A";

        if (champ !== "Aucune diff√©rence √† afficher") {
            differencesArray.push({ champ: champ, v1: v1, v2: v2 });
        }
    }

    if (differencesArray.length === 0) {
        alert("‚ùå Aucune diff√©rence √† notifier !");
        return;
    }

    // ‚ö° Envoyer au serveur Flask /notifier
    fetch("/notifier", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ differences: differencesArray })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === "success") {
            alert("‚úÖ Notification envoy√©e !");
        } else {
            alert("‚ùå Erreur : " + data.message);
        }
    })
    .catch(error => {
        console.error(error);
        alert("‚ùå Impossible d‚Äôenvoyer la notification.");
    });
}
</script>

</body>
</html>
